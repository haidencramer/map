<!DOCTYPE html>
<html>
<head>
    <title>Shared Pin Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .popup-form { display: flex; flex-direction: column; gap: 8px; width: 200px; }
        .popup-form input, .popup-form textarea { width: 100%; padding: 4px; box-sizing: border-box; }
        .popup-form button { background: #007bff; color: white; border: none; padding: 6px; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Initialize Map
    const map = L.map('map').setView([46.8721, -113.9940], 12);

    // 2. Add OpenStreetMap Tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // 3. Fetch and draw existing pins from our SQLite database
    async function loadPins() {
        const response = await fetch('/api/pins');
        const pins = await response.json();
        
        pins.forEach(pin => {
            L.marker([pin.lat, pin.lng])
             .addTo(map)
             .bindPopup(`<b>${pin.title}</b><br>${pin.comment}`);
        });
    }

    loadPins();

    // 4. Handle Map Clicks to add new pins
    let tempMarker = null;

    map.on('click', function(e) {
        // Remove existing temp marker if it exists
        if (tempMarker) map.removeLayer(tempMarker);

        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        // Create the HTML for the input form
        const formHtml = `
            <div class="popup-form">
                <strong>Add a Pin Here</strong>
                <input type="text" id="pin-title" placeholder="Title (e.g., Great Coffee)" required />
                <textarea id="pin-comment" placeholder="Leave a comment..."></textarea>
                <button onclick="submitPin(${lat}, ${lng})">Save Pin</button>
            </div>
        `;

        tempMarker = L.popup()
            .setLatLng(e.latlng)
            .setContent(formHtml)
            .openOn(map);
    });

    // 5. Submit the new pin to the FastAPI backend
    async function submitPin(lat, lng) {
        const title = document.getElementById('pin-title').value;
        const comment = document.getElementById('pin-comment').value;

        if (!title) return alert("Please enter a title!");

        const payload = { title, comment, lat, lng };

        const response = await fetch('/api/pins', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            map.closePopup();
            // Draw the new permanent marker
            L.marker([lat, lng])
             .addTo(map)
             .bindPopup(`<b>${title}</b><br>${comment}`);
        } else {
            alert("Error saving pin!");
        }
    }
</script>
</body>
</html>